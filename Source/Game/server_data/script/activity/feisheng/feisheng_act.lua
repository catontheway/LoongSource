
feisheng_fumo = {x=1605, y =13990, z =1866}  -- 伏魔仙者
feisheng_baimei = {x=1599, y =14088, z =1879}  -- 白眉仙官

feisheng_qilin = {}
feisheng_qilin[1] = {x=1242, y =8871, z =2136}     --赤火麒麟的刷出坐标
feisheng_qilin[2] = {x=1781, y =8580, z =457}
feisheng_qilin[3] = {x=1096, y =1182, z =98}
feisheng_qilin[4] = {x=1348, y =9236, z =1643}
feisheng_qilin[5] = {x=1197, y =13492, z =3369}
feisheng_qilin[6] = {x=1975, y =14366, z =3640}
feisheng_qilin[7] = {x=2954, y =7548, z =2685}
feisheng_qilin[8] = {x=2556, y =8424, z =2215}
feisheng_qilin[9] = {x=2426, y =7841, z =1633}
feisheng_qilin[10] = {x=2538, y =10036, z =1021}
feisheng_qilin[11] = {x=3511, y =10348, z =1546}

feisheng_baoshu = {}
feisheng_baoshu[1] = {x=1876, y =8000, z =2580}    -- 葵灵宝树的刷出坐标
feisheng_baoshu[2] = {x=1853, y =8065, z =2591}
feisheng_baoshu[3] = {x=1836, y =7935, z =2583}
feisheng_baoshu[4] = {x=1824, y =7834, z =2572}
feisheng_baoshu[5] = {x=1809, y =7823, z =2548}
feisheng_baoshu[6] = {x=1787, y =7948, z =2546}
feisheng_baoshu[7] = {x=1785, y =8030, z =2553}
feisheng_baoshu[8] = {x=1807, y =8075, z =2610}
feisheng_baoshu[9] = {x=1787, y =7981, z =2622}
feisheng_baoshu[10] = {x=1782, y =7991, z =2642}
feisheng_baoshu[11] = {x=1787, y =8010, z =2645}
feisheng_baoshu[12] = {x=1824, y =8375, z =2634}
feisheng_baoshu[13] = {x=1837, y =8384, z =2632}
feisheng_baoshu[14] = {x=1857, y =8415, z =2642}
feisheng_baoshu[15] = {x=1892, y =8172, z =2624}
feisheng_baoshu[16] = {x=1922, y =8118, z =2632}
feisheng_baoshu[17] = {x=1963, y =7898, z =2623}
feisheng_baoshu[18] = {x=1964, y =7805, z =2592}
feisheng_baoshu[19] = {x=1985, y =7729, z =2561}
feisheng_baoshu[20] = {x=1990, y =7733, z =2556}
feisheng_baoshu[21] = {x=1957, y =7771, z =2527}

feisheng_bossa = {}
--feisheng_bossa[1] = {x=1884, y =7712, z =2396}      -- 第一个BOSS刷出的位置的坐标
feisheng_bossa[1] = {x=1934, y =7912, z =2576}
feisheng_bossa[2] = {x=1941, y =7793, z =2391}
feisheng_bossa[3] = {x=1901, y =7802, z =2407}
feisheng_bossa[4] = {x=1860, y =7705, z =2406}
feisheng_bossa[5] = {x=1813, y =7627, z =2448}
feisheng_bossa[6] = {x=1782, y =7660, z =2489}
feisheng_bossa[7] = {x=1771, y =7979, z =2529}
feisheng_bossa[8] = {x=1802, y =7901, z =2556}
feisheng_bossa[9] = {x=1827, y =7845, z =2550}
feisheng_bossa[10] = {x=1863, y =7828, z =2552}
feisheng_bossa[11] = {x=1894, y =7679, z =2533}
feisheng_bossa[12] = {x=1898, y =7923, z =2560}
feisheng_bossa[13] = {x=1917, y =8036, z =2585}
feisheng_bossa[14] = {x=1915, y =8070, z =2610}
feisheng_bossa[15] = {x=1934, y =7912, z =2576}
feisheng_bossa[16] = {x=1946, y =7785, z =2501}
feisheng_bossa[17] = {x=1926, y =7849, z =2489}
feisheng_bossa[18] = {x=1864, y =7796, z =2506}
feisheng_bossa[19] = {x=1801, y =7771, z =2520}
feisheng_bossa[20] = {x=1855, y =7688, z =2481}
feisheng_bossa[21] = {x=1880, y =7739, z =2539}

feisheng_bossb = {}
--feisheng_bossb[1] = {x=1867, y =9053, z =2714}    -- 第贰个BOSS刷出的位置的坐标
feisheng_bossb[1] = {x=1787, y =7981, z =2622}
feisheng_bossb[2] = {x=1713, y =7938, z =2669}
feisheng_bossb[3] = {x=1726, y =7901, z =2681}
feisheng_bossb[4] = {x=1759, y =8023, z =2691}
feisheng_bossb[5] = {x=1787, y =8250, z =2696}
feisheng_bossb[6] = {x=1824, y =8340, z =2695}
feisheng_bossb[7] = {x=1843, y =8725, z =2713}
feisheng_bossb[8] = {x=1865, y =9030, z =2716}
feisheng_bossb[9] = {x=1905, y =8849, z =2707}
feisheng_bossb[10] = {x=1941, y =8350, z =2696}
feisheng_bossb[11] = {x=1978, y =8105, z =2689}
feisheng_bossb[12] = {x=1989, y =7920, z =2660}
feisheng_bossb[13] = {x=1970, y =7861, z =2622}
feisheng_bossb[14] = {x=1985, y =7853, z =2629}
feisheng_bossb[15] = {x=1938, y =7957, z =2609}
feisheng_bossb[16] = {x=1910, y =8108, z =2621}
feisheng_bossb[17] = {x=1874, y =9045, z =2694}
feisheng_bossb[18] = {x=1864, y =8984, z =2721}
feisheng_bossb[19] = {x=1879, y =882, z =2750}
feisheng_bossb[20] = {x=1915, y =8667, z =2783}
feisheng_bossb[21] = {x=1953, y =9820, z =2817}

KuiLingBaoShu_min = 0
KuiLingBaoShu_Start = 0
KuiLingBaoShu_Complete = 1
KuiLingBaoShu_ID1 = 0
KuiLingBaoShu_ID2 = 0
KuiLingBaoShu_ID3 = 0
KuiLingBaoShu_Times = 0    --记录教书和施肥一共的次数
KuiLingBaoShu_xiaoguai = 0
KuiLingBaoShu_jilu = {}  --KuiLingBaoShu_jilu[i] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
KuiLingBaoShu_jiaoshuitime = {}    --上次浇水的时间
KuiLingBaoShu_killboss = 0
KuiLingBaoShu_bossID = 0
KuiLingBaoShu_part = 1
KuiLingBaoShu_reward = {}


function KuiLingBaoShu(curweekday, curhour, curmin, KuiLingBaoShu_min)
    if KuiLingBaoShu_Start == 0 and KuiLingBaoShu_ID3 == 0 then
	    KuiLingBaoShu_jilu = {}
	    KuiLingBaoShu_ID1 = map.MapCreateColCreature(3017299407, -1, 4900703, feisheng_baoshu[1].x, feisheng_baoshu[1].y, feisheng_baoshu[1].z)
		KuiLingBaoShu_ID2 = 0
        KuiLingBaoShu_ID3 = 0
		KuiLingBaoShu_min = 1
		KuiLingBaoShu_Start = 1
		KuiLingBaoShu_Complete = 0
		KuiLingBaoShu_xiaoguai = 0
		KuiLingBaoShu_jiaoshuitime = {}
		KuiLingBaoShu_Times = 0
		KuiLingBaoShu_killboss = 0
		KuiLingBaoShu_boss = 0
		KuiLingBaoShu_part = 1
		KuiLingBaoShu_reward = {}
		msg.SendWorldSwitchMsg(5, 40, 70, 1, 99)
        msg.SendWorldSwitchMsg(6, 71, 100, 1, 99)
	end
	if KuiLingBaoShu_min == 5 then
	    local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 101, 3132)    --今天下午一点整，白眉仙官将会在凌霄天宫之下栽种葵灵宝树，届时所有40级以上的玩家都可以前去相助！
		msg.DispatchWorldMsgEvent(MsgID)
	end
	if KuiLingBaoShu_min == 2 then
	    local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 101, 3143)    --葵灵树种已经被播种在凌霄天宫下方【1876，2580】,请从白眉仙官处领取灵水后前去
	    msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
	elseif KuiLingBaoShu_min == 30 then
	    if KuiLingBaoShu_part == 1 then
		    KuiLingBaoShu_part = 2
		    local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 101, 3144)    --30分钟结束！葵灵树种顺利成长到第二阶段，变成葵灵幼树！
			msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
			local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 101, 3147)    --新的妖魔首领已经出现！它们的掉落所有玩家都可以拾取！
			msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
			KuiLingBaoShu_ID2 = map.MapCreateColCreature(3017299407, -1, 4900704, feisheng_baoshu[1].x, feisheng_baoshu[1].y, feisheng_baoshu[1].z)
		    map.MapDeleteCreature(3017299407, -1, KuiLingBaoShu_ID1)
			KuiLingBaoShu_ID1 = 0
			KuiLingBaoShu_Times = 0
			map.MapCreateColCreature(3017299407, -1, 1535301, feisheng_bossa[1].x, feisheng_bossa[1].y, feisheng_bossa[1].z)
			map.MapCreateColCreature(3017299407, -1, 1535302, feisheng_bossb[1].x, feisheng_bossb[1].y, feisheng_bossb[1].z)
		end
	elseif KuiLingBaoShu_min == 60 then
        if KuiLingBaoShu_part == 2 then
		    KuiLingBaoShu_part = 3
            local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 101, 3145)    --60分钟结束！葵灵幼树顺利成长到第三阶段，变成葵灵宝树！
			msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
			local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 101, 3147)    --新的妖魔首领已经出现！它们的掉落所有玩家都可以拾取！
			msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
			KuiLingBaoShu_ID3 = map.MapCreateColCreature(3017299407, -1, 4900705, feisheng_baoshu[1].x, feisheng_baoshu[1].y, feisheng_baoshu[1].z)
		    map.MapDeleteCreature(3017299407, -1, KuiLingBaoShu_ID2)
			KuiLingBaoShu_ID2 = 0
			KuiLingBaoShu_Times = 0
			map.MapCreateColCreature(3017299407, -1, 1535304, feisheng_bossa[1].x, feisheng_bossa[1].y, feisheng_bossa[1].z)
			map.MapCreateColCreature(3017299407, -1, 1535303, feisheng_bossb[1].x, feisheng_bossb[1].y, feisheng_bossb[1].z)
        end
	elseif KuiLingBaoShu_min == 90 then
        if KuiLingBaoShu_part == 3 then
		    KuiLingBaoShu_part = 4
            local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 101, 3146)    --90分钟结束！葵灵宝树已经长成，所有玩家可以向其领取经验奖励！
			msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
			local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 101, 3147)    --新的妖魔首领已经出现！它们的掉落所有玩家都可以拾取！
			msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
			KuiLingBaoShu_Times = 500
			map.MapCreateColCreature(3017299407, -1, 1535305, feisheng_bossa[1].x, feisheng_bossa[1].y, feisheng_bossa[1].z)
			map.MapCreateColCreature(3017299407, -1, 1535306, feisheng_bossb[1].x, feisheng_bossb[1].y, feisheng_bossb[1].z)
			KuiLingBaoShu_Start = 0
		    KuiLingBaoShu_Complete = 1
        end
	end
end

-- npc对话，兑换过程
function x4900703_OnTalk(MapID, InstanceID, TargetID, TargetTypeID, RoleID, TalkIndex)

	if TalkIndex == -1 then    	--开始对话
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 20, 3148)	--        你可以使用从白眉仙官【1599,1889】处领取的天界灵水来浇灌葵灵树种。每个人每分钟只能浇灌一次，葵灵树种将在浇灌500次或者30分钟后成长为葵灵幼树。\n        葵灵树种浇灌次数：XX/500
		msg.AddMsgEvent(MsgID, 24, TargetID)
		msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_Times)
		msg.AddMsgEvent(MsgID, 21, 5)	-- 确定按钮
		msg.AddMsgEvent(MsgID, 1, 3149)	-- "浇水"
		msg.AddMsgEvent(MsgID, 21, 6)	-- 确定按钮
		msg.AddMsgEvent(MsgID, 1, 3150)	-- "查询活动信息"
		msg.AddMsgEvent(MsgID, 21, 19)	-- 确定按钮
		msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
	elseif TalkIndex == 5 then
        if KuiLingBaoShu_jiaoshuitime[RoleID] == nil then
			KuiLingBaoShu_jiaoshuitime[RoleID] = 0
		end
		if KuiLingBaoShu_xiaoguai <= 40 then
			local i = role.GetRoleItemNum(RoleID, 1351202)
			if i > 0 then
				local cTime = os.time() --当前时间
				local s = 0
				if KuiLingBaoShu_jiaoshuitime[RoleID] == 0 then
					s = 61
				else
					s = os.difftime(cTime,KuiLingBaoShu_jiaoshuitime[RoleID]) --上次浇水距现在时间
				end
				if 	s > 60 then --间隔大于1分钟
					KuiLingBaoShu_Times = KuiLingBaoShu_Times + 1
					CreatCreature_KuiLingBaoShu(MapID, InstanceID)  --随机刷怪
					if KuiLingBaoShu_Times == 1000 then
						KuiLingBaoShu_part = 2
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 101, 3155)    --经过500次浇水，葵灵树种顺利成长到第二阶段，变成葵灵幼树！
						msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 101, 3147)    --新的妖魔首领已经出现！它们的掉落所有玩家都可以拾取！
						msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
						KuiLingBaoShu_ID2 = map.MapCreateColCreature(3017299407, -1, 4900704, feisheng_baoshu[1].x, feisheng_baoshu[1].y, feisheng_baoshu[1].z)
						map.MapDeleteCreature(3017299407, -1, KuiLingBaoShu_ID1)
						KuiLingBaoShu_ID1 = 0
						KuiLingBaoShu_Times = 0
						map.MapCreateColCreature(3017299407, -1, 1535301, feisheng_bossa[1].x, feisheng_bossa[1].y, feisheng_bossa[1].z)
						map.MapCreateColCreature(3017299407, -1, 1535302, feisheng_bossb[1].x, feisheng_bossb[1].y, feisheng_bossb[1].z)
					end
					KuiLingBaoShu_jiaoshuitime[RoleID] = cTime
					role.RemoveFromRole(MapID, InstanceID, RoleID, 1351202, 1, 101)
					local TeamID = role.IsRoleHaveTeam(MapID, InstanceID, RoleID)
					if TeamID == nil or TeamID == 4294967295 then
						if KuiLingBaoShu_jilu[RoleID] == nil then
							KuiLingBaoShu_jilu[RoleID] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
						end
						if KuiLingBaoShu_jilu[RoleID].jiaoshui < 120 then
							local rolelevel = role.GetRoleLevel(MapID, InstanceID, RoleID)
							local roleexp = math.floor(activity_newexp[rolelevel] / 40 / 6)
							role.AddRoleExp(MapID, InstanceID, RoleID, roleexp)
						end
						KuiLingBaoShu_jilu[RoleID].jiaoshui = KuiLingBaoShu_jilu[RoleID].jiaoshui + 1
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 26, 3151)	--浇水或施肥次数：XX/120
						msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].jiaoshui)
						msg.DispatchRoleMsgEvent(RoleID, MsgID)
					else
					    local Role = {}
						Role[1], Role[2], Role[3], Role[4], Role[5], Role[6] = role.GetRoleTeamMemID(TeamID)
						local p = 0
						for k = 1,6 do
							if 4294967295 ~= Role[k] and nil ~= Role[k] then
								p = p + 1
							end
						end
						for k = 1,6 do
							if 4294967295 ~= Role[k] and nil ~= Role[k] then
								if KuiLingBaoShu_jilu[Role[k]] == nil then
									KuiLingBaoShu_jilu[Role[k]] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
								end
								if KuiLingBaoShu_jilu[Role[k]].jiaoshui < 120 then
									local rolelevel = role.GetRoleLevel(MapID, InstanceID, Role[k])
									local roleexp = math.floor(activity_newexp[rolelevel] / 40 / 6 * p)
									role.AddRoleExp(MapID, InstanceID, Role[k], roleexp)
								end
								KuiLingBaoShu_jilu[Role[k]].jiaoshui = KuiLingBaoShu_jilu[Role[k]].jiaoshui + 1
								local MsgID = msg.BeginMsgEvent()
								msg.AddMsgEvent(MsgID, 26, 3151)	--浇水或施肥次数：XX/120
								msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[Role[k]].jiaoshui)
								msg.DispatchRoleMsgEvent(Role[k], MsgID)
							end
						end
					end
				else
					local MsgID = msg.BeginMsgEvent()
					msg.AddMsgEvent(MsgID, 20, 3152)	--        没人每分钟只能浇水或者施肥一次。距离您下次可以浇水还有XX秒。
					msg.AddMsgEvent(MsgID, 24, TargetID)
					msg.AddMsgEvent(MsgID, 9, 60-s)
					msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
					msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
					msg.DispatchRoleMsgEvent(RoleID, MsgID)
				end
			else
			    local MsgID = msg.BeginMsgEvent()
			    msg.AddMsgEvent(MsgID, 20, 3153)	--        请您先从白眉仙官处领取天界灵水之后再来浇水。
				msg.AddMsgEvent(MsgID, 24, TargetID)
				msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
				msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
				msg.DispatchRoleMsgEvent(RoleID, MsgID)
			end
		else
		    local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 20, 3154)	--        存活的怪物数量达到XX只。当存活怪物的数量达到40只的时候，强大的妖气将导致葵灵宝树无法生长。
			msg.AddMsgEvent(MsgID, 24, TargetID)
			msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_xiaoguai)
			msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
			msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
			msg.DispatchRoleMsgEvent(RoleID, MsgID)
		end
	elseif TalkIndex == 6 then
	    if KuiLingBaoShu_jilu[RoleID] == nil then
		    KuiLingBaoShu_jilu[RoleID] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
	    end
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 20, 3156)	--        您目前已经浇水XX/120次。\n        您的混沌经验箱现在已经储存妖魔之魂XX个。
		msg.AddMsgEvent(MsgID, 24, TargetID)
		msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].jiaoshui)
		msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].guaiwu)
		msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
		msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
	end
end


-- 注册相应事件
aux.RegisterCreatureEvent(4900703, 7, "x4900703_OnTalk")

-- npc对话，兑换过程
function x4900704_OnTalk(MapID, InstanceID, TargetID, TargetTypeID, RoleID, TalkIndex)

	if TalkIndex == -1 then    	--开始对话
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 20, 3157)	--        你可以使用从白眉仙官【1599,1889】处领取的天界灵水来浇灌葵灵树种。每个人每分钟只能浇灌一次，葵灵树种将在浇灌500次或者30分钟后成长为葵灵幼树。\n        葵灵树种浇灌次数：XX/500
		msg.AddMsgEvent(MsgID, 24, TargetID)
		msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_Times)
		msg.AddMsgEvent(MsgID, 21, 5)	-- 确定按钮
		msg.AddMsgEvent(MsgID, 1, 3158)	-- "施肥"
		msg.AddMsgEvent(MsgID, 21, 6)	-- 确定按钮
		msg.AddMsgEvent(MsgID, 1, 3150)	-- "查询活动信息"
		msg.AddMsgEvent(MsgID, 21, 19)	-- 确定按钮
		msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
	elseif TalkIndex == 5 then
        if KuiLingBaoShu_jiaoshuitime[RoleID] == nil then
			KuiLingBaoShu_jiaoshuitime[RoleID] = 0
		end
		if KuiLingBaoShu_xiaoguai <= 40 then
			local i = role.GetRoleItemNum(RoleID, 1351201)
			if i > 0 then
				local cTime = os.time() --当前时间
				local s = 0
				if KuiLingBaoShu_jiaoshuitime[RoleID] == 0 then
					s = 61
				else
					s = os.difftime(cTime,KuiLingBaoShu_jiaoshuitime[RoleID]) --上次浇水距现在时间
				end
				if 	s > 60 then --间隔大于1分钟
					KuiLingBaoShu_Times = KuiLingBaoShu_Times + 1
					CreatCreature_KuiLingBaoShu(MapID, InstanceID)  --随机刷怪
					if KuiLingBaoShu_Times == 1000 then
						KuiLingBaoShu_part = 3
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 101, 3159)    --经过500次浇水，葵灵树种顺利成长到第二阶段，变成葵灵幼树！
						msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 101, 3147)    --新的妖魔首领已经出现！它们的掉落所有玩家都可以拾取！
						msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
						KuiLingBaoShu_ID2 = map.MapCreateColCreature(3017299407, -1, 4900705, feisheng_baoshu[1].x, feisheng_baoshu[1].y, feisheng_baoshu[1].z)
						map.MapDeleteCreature(3017299407, -1, KuiLingBaoShu_ID2)
						KuiLingBaoShu_ID2 = 0
						KuiLingBaoShu_Times = 0
						map.MapCreateColCreature(3017299407, -1, 1535304, feisheng_bossa[1].x, feisheng_bossa[1].y, feisheng_bossa[1].z)
						map.MapCreateColCreature(3017299407, -1, 1535303, feisheng_bossb[1].x, feisheng_bossb[1].y, feisheng_bossb[1].z)
					end
					KuiLingBaoShu_jiaoshuitime[RoleID] = cTime
					role.RemoveFromRole(MapID, InstanceID, RoleID, 1351201, 1, 101)
					local TeamID = role.IsRoleHaveTeam(MapID, InstanceID, RoleID)
					if TeamID == nil or TeamID == 4294967295 then
						if KuiLingBaoShu_jilu[RoleID] == nil then
							KuiLingBaoShu_jilu[RoleID] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
						end
						if KuiLingBaoShu_jilu[RoleID].jiaoshui < 120 then
							local rolelevel = role.GetRoleLevel(MapID, InstanceID, RoleID)
							local roleexp = math.floor(activity_newexp[rolelevel] / 40 / 6)
							role.AddRoleExp(MapID, InstanceID, RoleID, roleexp)
						end
						KuiLingBaoShu_jilu[RoleID].jiaoshui = KuiLingBaoShu_jilu[RoleID].jiaoshui + 1
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 26, 3151)	--浇水或施肥次数：XX/120
						msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].jiaoshui)
						msg.DispatchRoleMsgEvent(RoleID, MsgID)
					else
					    local Role = {}
						Role[1], Role[2], Role[3], Role[4], Role[5], Role[6] = role.GetRoleTeamMemID(TeamID)
						local p = 0
						for k = 1,6 do
							if 4294967295 ~= Role[k] and nil ~= Role[k] then
								p = p + 1
							end
						end
						for k = 1,6 do
							if 4294967295 ~= Role[k] and nil ~= Role[k] then
								if KuiLingBaoShu_jilu[Role[k]] == nil then
									KuiLingBaoShu_jilu[Role[k]] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
								end
								if KuiLingBaoShu_jilu[Role[k]].jiaoshui < 120 then
									local rolelevel = role.GetRoleLevel(MapID, InstanceID, Role[k])
									local roleexp = math.floor(activity_newexp[rolelevel] / 40 / 6 * p)
									role.AddRoleExp(MapID, InstanceID, Role[k], roleexp)
								end
								KuiLingBaoShu_jilu[Role[k]].jiaoshui = KuiLingBaoShu_jilu[Role[k]].jiaoshui + 1
								local MsgID = msg.BeginMsgEvent()
								msg.AddMsgEvent(MsgID, 26, 3151)	--浇水或施肥次数：XX/120
								msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[Role[k]].jiaoshui)
								msg.DispatchRoleMsgEvent(Role[k], MsgID)
							end
						end
					end
				else
					local MsgID = msg.BeginMsgEvent()
					msg.AddMsgEvent(MsgID, 20, 3152)	--        没人每分钟只能浇水或者施肥一次。距离您下次可以浇水还有XX秒。
					msg.AddMsgEvent(MsgID, 24, TargetID)
					msg.AddMsgEvent(MsgID, 9, 60-s)
					msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
					msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
					msg.DispatchRoleMsgEvent(RoleID, MsgID)
				end
			else
			    local MsgID = msg.BeginMsgEvent()
			    msg.AddMsgEvent(MsgID, 20, 3160)	--        请您先从白眉仙官处领取天界灵水之后再来浇水。
				msg.AddMsgEvent(MsgID, 24, TargetID)
				msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
				msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
				msg.DispatchRoleMsgEvent(RoleID, MsgID)
			end
		else
		    local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 20, 3154)	--        存活的怪物数量达到XX只。当存活怪物的数量达到40只的时候，强大的妖气将导致葵灵宝树无法生长。
			msg.AddMsgEvent(MsgID, 24, TargetID)
			msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_xiaoguai)
			msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
			msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
			msg.DispatchRoleMsgEvent(RoleID, MsgID)
		end
	elseif TalkIndex == 6 then
	    if KuiLingBaoShu_jilu[RoleID] == nil then
		    KuiLingBaoShu_jilu[RoleID] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
	    end
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 20, 3156)	--        您目前已经浇水XX/120次。\n        您的混沌经验箱现在已经储存妖魔之魂XX个。
		msg.AddMsgEvent(MsgID, 24, TargetID)
		msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].jiaoshui)
		msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].guaiwu)
		msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
		msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
	end
end


-- 注册相应事件
aux.RegisterCreatureEvent(4900704, 7, "x4900704_OnTalk")

-- npc对话，兑换过程
function x4900705_OnTalk(MapID, InstanceID, TargetID, TargetTypeID, RoleID, TalkIndex)

	if TalkIndex == -1 then    	--开始对话
	    if KuiLingBaoShu_part == 3 then
			local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 20, 3162)	--        你可以使用从白眉仙官【1599,1889】处领取的天界灵水来浇灌葵灵树种。每个人每分钟只能浇灌一次，葵灵树种将在浇灌500次或者30分钟后成长为葵灵幼树。\n        葵灵树种浇灌次数：XX/500
			msg.AddMsgEvent(MsgID, 24, TargetID)
			msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_Times)
			msg.AddMsgEvent(MsgID, 21, 7)	-- 确定按钮
			msg.AddMsgEvent(MsgID, 1, 3149)	-- "浇水"
			msg.AddMsgEvent(MsgID, 21, 5)	-- 确定按钮
			msg.AddMsgEvent(MsgID, 1, 3158)	-- "施肥"
			msg.AddMsgEvent(MsgID, 21, 6)	-- 确定按钮
			msg.AddMsgEvent(MsgID, 1, 3150)	-- "查询活动信息"
			msg.AddMsgEvent(MsgID, 21, 19)	-- 确定按钮
			msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
			msg.DispatchRoleMsgEvent(RoleID, MsgID)
		elseif KuiLingBaoShu_part == 4 then
		    if KuiLingBaoShu_killboss < 7 then
				local MsgID = msg.BeginMsgEvent()
				msg.AddMsgEvent(MsgID, 20, 3163)	--        葵灵宝树已经长成！杀掉妖魔的最终首领蚩尤妖魂后可以在葵灵宝树处领取最终奖励！
				msg.AddMsgEvent(MsgID, 24, TargetID)
				msg.AddMsgEvent(MsgID, 21, 19)	-- 确定按钮
				msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
				msg.DispatchRoleMsgEvent(RoleID, MsgID)
			elseif KuiLingBaoShu_killboss == 7 then
			    local MsgID = msg.BeginMsgEvent()
				msg.AddMsgEvent(MsgID, 20, 3164)	--        葵灵宝树已经具有足够的力量抵御妖魔的入侵。这是一个值得庆祝的事情！所有昆仑的玩家都可以从葵灵宝树上领取经验。
				msg.AddMsgEvent(MsgID, 24, TargetID)
				msg.AddMsgEvent(MsgID, 21, 8)	-- 确定按钮
				msg.AddMsgEvent(MsgID, 1, 3165)	-- "领取奖励经验"
				msg.AddMsgEvent(MsgID, 21, 19)	-- 确定按钮
				msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
				msg.DispatchRoleMsgEvent(RoleID, MsgID)
			end
		end
	elseif TalkIndex == 5 then
        if KuiLingBaoShu_jiaoshuitime[RoleID] == nil then
			KuiLingBaoShu_jiaoshuitime[RoleID] = 0
		end
		if KuiLingBaoShu_xiaoguai <= 40 then
			local i = role.GetRoleItemNum(RoleID, 1351201)
			if i > 0 then
				local cTime = os.time() --当前时间
				local s = 0
				if KuiLingBaoShu_jiaoshuitime[RoleID] == 0 then
					s = 61
				else
					s = os.difftime(cTime,KuiLingBaoShu_jiaoshuitime[RoleID]) --上次浇水距现在时间
				end
				if 	s > 60 then --间隔大于1分钟
					KuiLingBaoShu_Times = KuiLingBaoShu_Times + 1
					if KuiLingBaoShu_Times % 5 == 0 then
					    unit.AddBuff(MapID, InstanceID, TargetID, 9431101, TargetID)
					end
					CreatCreature_KuiLingBaoShu(MapID, InstanceID)  --随机刷怪
					if KuiLingBaoShu_Times == 1000 then
					     KuiLingBaoShu_Start = 0
		                KuiLingBaoShu_Complete = 1
						KuiLingBaoShu_part = 4
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 101, 3161)    --经过500次浇水，葵灵树种顺利成长到第二阶段，变成葵灵幼树！
						msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 101, 3147)    --新的妖魔首领已经出现！它们的掉落所有玩家都可以拾取！
						msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
						KuiLingBaoShu_Times = 0
						map.MapCreateColCreature(3017299407, -1, 1535305, feisheng_bossa[1].x, feisheng_bossa[1].y, feisheng_bossa[1].z)
						map.MapCreateColCreature(3017299407, -1, 1535306, feisheng_bossb[1].x, feisheng_bossb[1].y, feisheng_bossb[1].z)
					end
					KuiLingBaoShu_jiaoshuitime[RoleID] = cTime
					role.RemoveFromRole(MapID, InstanceID, RoleID, 1351201, 1, 101)
					local TeamID = role.IsRoleHaveTeam(MapID, InstanceID, RoleID)
					if TeamID == nil or TeamID == 4294967295 then
						if KuiLingBaoShu_jilu[RoleID] == nil then
							KuiLingBaoShu_jilu[RoleID] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
						end
						if KuiLingBaoShu_jilu[RoleID].jiaoshui < 120 then
							local rolelevel = role.GetRoleLevel(MapID, InstanceID, RoleID)
							local roleexp = math.floor(activity_newexp[rolelevel] / 40/ 6)
							role.AddRoleExp(MapID, InstanceID, RoleID, roleexp)
						end
						KuiLingBaoShu_jilu[RoleID].jiaoshui = KuiLingBaoShu_jilu[RoleID].jiaoshui + 1
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 26, 3151)	--浇水或施肥次数：XX/120
						msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].jiaoshui)
						msg.DispatchRoleMsgEvent(RoleID, MsgID)
					else
					    local Role = {}
						Role[1], Role[2], Role[3], Role[4], Role[5], Role[6] = role.GetRoleTeamMemID(TeamID)
						local p = 0
						for k = 1,6 do
							if 4294967295 ~= Role[k] and nil ~= Role[k] then
								p = p + 1
							end
						end
						for k = 1,6 do
							if 4294967295 ~= Role[k] and nil ~= Role[k] then
								if KuiLingBaoShu_jilu[Role[k]] == nil then
									KuiLingBaoShu_jilu[Role[k]] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
								end
								if KuiLingBaoShu_jilu[Role[k]].jiaoshui < 120 then
									local rolelevel = role.GetRoleLevel(MapID, InstanceID, Role[k])
									local roleexp = math.floor(activity_newexp[rolelevel] / 40 /6 *p)
									role.AddRoleExp(MapID, InstanceID, Role[k], roleexp)
								end
								KuiLingBaoShu_jilu[Role[k]].jiaoshui = KuiLingBaoShu_jilu[Role[k]].jiaoshui + 1
								local MsgID = msg.BeginMsgEvent()
								msg.AddMsgEvent(MsgID, 26, 3151)	--浇水或施肥次数：XX/120
								msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[Role[k]].jiaoshui)
								msg.DispatchRoleMsgEvent(Role[k], MsgID)
							end
						end
					end
				else
					local MsgID = msg.BeginMsgEvent()
					msg.AddMsgEvent(MsgID, 20, 3152)	--        没人每分钟只能浇水或者施肥一次。距离您下次可以浇水还有XX秒。
					msg.AddMsgEvent(MsgID, 24, TargetID)
					msg.AddMsgEvent(MsgID, 9, 60-s)
					msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
					msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
					msg.DispatchRoleMsgEvent(RoleID, MsgID)
				end
			else
			    local MsgID = msg.BeginMsgEvent()
			    msg.AddMsgEvent(MsgID, 20, 3160)	--        请您先从白眉仙官处领取天界灵水之后再来浇水。
				msg.AddMsgEvent(MsgID, 24, TargetID)
				msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
				msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
				msg.DispatchRoleMsgEvent(RoleID, MsgID)
			end
		else
		    local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 20, 3154)	--        存活的怪物数量达到XX只。当存活怪物的数量达到40只的时候，强大的妖气将导致葵灵宝树无法生长。
			msg.AddMsgEvent(MsgID, 24, TargetID)
			msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_xiaoguai)
			msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
			msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
			msg.DispatchRoleMsgEvent(RoleID, MsgID)
		end
	elseif TalkIndex == 7 then
        if KuiLingBaoShu_jiaoshuitime[RoleID] == nil then
			KuiLingBaoShu_jiaoshuitime[RoleID] = 0
		end
		if KuiLingBaoShu_xiaoguai <= 40 then
			local i = role.GetRoleItemNum(RoleID, 1351202)
			if i > 0 then
				local cTime = os.time() --当前时间
				local s = 0
				if KuiLingBaoShu_jiaoshuitime[RoleID] == 0 then
					s = 61
				else
					s = os.difftime(cTime,KuiLingBaoShu_jiaoshuitime[RoleID]) --上次浇水距现在时间
				end
				if 	s > 60 then --间隔大于1分钟
					KuiLingBaoShu_Times = KuiLingBaoShu_Times + 1
					if KuiLingBaoShu_Times % 5 == 0 then
					    unit.AddBuff(MapID, InstanceID, TargetID, 9431101, TargetID)
					end
					CreatCreature_KuiLingBaoShu(MapID, InstanceID)  --随机刷怪
					if KuiLingBaoShu_Times == 1000 then
					    KuiLingBaoShu_Start = 0
		                KuiLingBaoShu_Complete = 1
						KuiLingBaoShu_part = 4
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 101, 3161)    --经过500次浇水，葵灵树种顺利成长到第二阶段，变成葵灵幼树！
						msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 101, 3147)    --新的妖魔首领已经出现！它们的掉落所有玩家都可以拾取！
						msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
						KuiLingBaoShu_Times = 0
						map.MapCreateColCreature(3017299407, -1, 1535305, feisheng_bossa[1].x, feisheng_bossa[1].y, feisheng_bossa[1].z)
						map.MapCreateColCreature(3017299407, -1, 1535306, feisheng_bossb[1].x, feisheng_bossb[1].y, feisheng_bossb[1].z)
					end
					KuiLingBaoShu_jiaoshuitime[RoleID] = cTime
					role.RemoveFromRole(MapID, InstanceID, RoleID, 1351202, 1, 101)
					local TeamID = role.IsRoleHaveTeam(MapID, InstanceID, RoleID)
					if TeamID == nil or TeamID == 4294967295 then
						if KuiLingBaoShu_jilu[RoleID] == nil then
							KuiLingBaoShu_jilu[RoleID] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
						end
						if KuiLingBaoShu_jilu[RoleID].jiaoshui < 120 then
							local rolelevel = role.GetRoleLevel(MapID, InstanceID, RoleID)
							local roleexp = math.floor(activity_newexp[rolelevel] / 40 / 6)
							role.AddRoleExp(MapID, InstanceID, RoleID, roleexp)
						end
						KuiLingBaoShu_jilu[RoleID].jiaoshui = KuiLingBaoShu_jilu[RoleID].jiaoshui + 1
						local MsgID = msg.BeginMsgEvent()
						msg.AddMsgEvent(MsgID, 26, 3151)	--浇水或施肥次数：XX/120
						msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].jiaoshui)
						msg.DispatchRoleMsgEvent(RoleID, MsgID)
					else
					    local Role = {}
						Role[1], Role[2], Role[3], Role[4], Role[5], Role[6] = role.GetRoleTeamMemID(TeamID)
						local p = 0
						for k = 1,6 do
							if 4294967295 ~= Role[k] and nil ~= Role[k] then
								p = p + 1
							end
						end
						for k = 1,6 do
							if 4294967295 ~= Role[k] and nil ~= Role[k] then
								if KuiLingBaoShu_jilu[Role[k]] == nil then
									KuiLingBaoShu_jilu[Role[k]] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
								end
								if KuiLingBaoShu_jilu[Role[k]].jiaoshui < 120 then
									local rolelevel = role.GetRoleLevel(MapID, InstanceID, Role[k])
									local roleexp = math.floor(activity_newexp[rolelevel] / 40 / 6 * p)
									role.AddRoleExp(MapID, InstanceID, Role[k], roleexp)
								end
								KuiLingBaoShu_jilu[Role[k]].jiaoshui = KuiLingBaoShu_jilu[Role[k]].jiaoshui + 1
								local MsgID = msg.BeginMsgEvent()
								msg.AddMsgEvent(MsgID, 26, 3151)	--浇水或施肥次数：XX/120
								msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[Role[k]].jiaoshui)
								msg.DispatchRoleMsgEvent(Role[k], MsgID)
							end
						end
					end
				else
					local MsgID = msg.BeginMsgEvent()
					msg.AddMsgEvent(MsgID, 20, 3152)	--        没人每分钟只能浇水或者施肥一次。距离您下次可以浇水还有XX秒。
					msg.AddMsgEvent(MsgID, 24, TargetID)
					msg.AddMsgEvent(MsgID, 9, 60-s)
					msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
					msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
					msg.DispatchRoleMsgEvent(RoleID, MsgID)
				end
			else
			    local MsgID = msg.BeginMsgEvent()
			    msg.AddMsgEvent(MsgID, 20, 3153)	--        请您先从白眉仙官处领取天界灵水之后再来浇水。
				msg.AddMsgEvent(MsgID, 24, TargetID)
				msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
				msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
				msg.DispatchRoleMsgEvent(RoleID, MsgID)
			end
		else
		    local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 20, 3154)	--        存活的怪物数量达到XX只。当存活怪物的数量达到40只的时候，强大的妖气将导致葵灵宝树无法生长。
			msg.AddMsgEvent(MsgID, 24, TargetID)
			msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_xiaoguai)
			msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
			msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
			msg.DispatchRoleMsgEvent(RoleID, MsgID)
		end
	elseif TalkIndex == 6 then
	    if KuiLingBaoShu_jilu[RoleID] == nil then
		    KuiLingBaoShu_jilu[RoleID] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
	    end
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 20, 3156)	--        您目前已经浇水XX/120次。\n        您的混沌经验箱现在已经储存妖魔之魂XX个。
		msg.AddMsgEvent(MsgID, 24, TargetID)
		msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].jiaoshui)
		msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].guaiwu)
		msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
		msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
	elseif TalkIndex == 8 then
	    if KuiLingBaoShu_reward[RoleID] == nil then
            KuiLingBaoShu_reward[RoleID] = 1
           	local rolelevel = role.GetRoleLevel(MapID, InstanceID, RoleID)
			role.AddRoleExp(MapID, InstanceID, RoleID, activity_newexp[rolelevel])
		    local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 20, 3166)	--        葵灵宝树活动完成！获得经验XX点。\n        下周日13:00葵灵宝树活动将会重新开放，请大家踊跃参加。
			msg.AddMsgEvent(MsgID, 24, TargetID)
			msg.AddMsgEvent(MsgID, 9, activity_newexp[rolelevel])
			msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
			msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
			msg.DispatchRoleMsgEvent(RoleID, MsgID)
		else
		    local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 20, 3167)	--        本次活动您已经领取过一次经验，不能重复领取。\n        下周日13:00葵灵宝树活动将会重新开放，请大家踊跃参加。
			msg.AddMsgEvent(MsgID, 24, TargetID)
			msg.AddMsgEvent(MsgID, 21, -1)	-- 确定按钮
			msg.AddMsgEvent(MsgID, 1, 207)	-- "返回"
			msg.DispatchRoleMsgEvent(RoleID, MsgID)
		end
	end
end


-- 注册相应事件
aux.RegisterCreatureEvent(4900705, 7, "x4900705_OnTalk")

--当葵灵宝树消失的时候，修改全局变量
function c4900705_OnDisappear(MapID, InstanceID, TargetID, TargetTypeID)

    KuiLingBaoShu_ID1 = 0
	KuiLingBaoShu_ID2 = 0
	KuiLingBaoShu_ID3 = 0
	KuiLingBaoShu_min = 0
	KuiLingBaoShu_xiaoguai = 0
	KuiLingBaoShu_jiaoshuitime = {}
	KuiLingBaoShu_Times = 0
	KuiLingBaoShu_boss = 0
	KuiLingBaoShu_reward = {}

end

aux.RegisterCreatureEvent(4900705, 13, "c4900705_OnDisappear")

--[[玩家在竞技场中杀人
function JinngJiChang_KillPeople(MapID, InstanceID, RoleID, KillerID)
	if unit.IsPlayer(RoleID) and not unit.IsPlayer(KillerID) then
	    local TypeID = cre.GetCreatureTypeID(MapID,InstanceID, KillerID)
		if TypeID ==  1535307 then
		    cre.MonsterSay(MapID, InstanceID, KillerID, 50081)
		    unit.AddBuff(MapID, InstanceID, KillerID, 9431401, KillerID)
            local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 101, 3168)    --蚩尤妖魂杀掉了XXX！蚩尤妖魂变得更加凶残了！
			msg.AddMsgEvent(MsgID, 2, RoleID)
			msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
		end
	end
end

aux.RegisterMapEvent("m07", 5, "m07_KillPeople")]]

--怪物死亡
function Kuilingxiaoguai_OnDie(MapID, InstanceID, TargetID, TargetTypeID, RoleID)
	if math.random(10) == 5 then
	    local k = math.random(5)
		cre.MonsterSay(MapID, InstanceID, TargetID, 50073 + k)
	end
	if KuiLingBaoShu_xiaoguai > 0 then
	    KuiLingBaoShu_xiaoguai = KuiLingBaoShu_xiaoguai - 1
	end
	if RoleID ~= nil and unit.IsPlayer(RoleID) then
	    if role.GetRoleItemNum(RoleID, 1351214) == 1 then
			local TeamID = role.IsRoleHaveTeam(MapID, InstanceID, RoleID)
			if TeamID == nil or TeamID == 4294967295 then
				if KuiLingBaoShu_jilu[RoleID] == nil then
					KuiLingBaoShu_jilu[RoleID] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
				end
				KuiLingBaoShu_jilu[RoleID].guaiwu = KuiLingBaoShu_jilu[RoleID].guaiwu + 1
				local MsgID = msg.BeginMsgEvent()
				msg.AddMsgEvent(MsgID, 26, 3169)	--混沌经验箱储存妖魂增加，达到XXX个
				msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].guaiwu)
				msg.DispatchRoleMsgEvent(RoleID, MsgID)
			else
			    local Role = {}
				Role[1], Role[2], Role[3], Role[4], Role[5], Role[6] = role.GetRoleTeamMemID(TeamID)
				for k = 1,6 do
					if 4294967295 ~= Role[k] and nil ~= Role[k] then
					    if role.GetRoleItemNum(Role[k], 1351214) == 1 then
							if KuiLingBaoShu_jilu[Role[k]] == nil then
								KuiLingBaoShu_jilu[Role[k]] = {jingyanxiang = 0, guaiwu = 0, jiaoshui = 0}
							end
							KuiLingBaoShu_jilu[Role[k]].guaiwu = KuiLingBaoShu_jilu[Role[k]].guaiwu + 1
							local MsgID = msg.BeginMsgEvent()
							msg.AddMsgEvent(MsgID, 26, 3169)	--混沌经验箱储存妖魂增加，达到XXX个
							msg.AddMsgEvent(MsgID, 9, KuiLingBaoShu_jilu[RoleID].guaiwu)
							msg.DispatchRoleMsgEvent(RoleID, MsgID)
						end
					end
				end
			end
		end
    end
end

aux.RegisterCreatureEvent(1535308, 4, "Kuilingxiaoguai_OnDie")
aux.RegisterCreatureEvent(1535309, 4, "Kuilingxiaoguai_OnDie")
aux.RegisterCreatureEvent(1535310, 4, "Kuilingxiaoguai_OnDie")
aux.RegisterCreatureEvent(1535311, 4, "Kuilingxiaoguai_OnDie")

--BOSS死亡
function KuilingBoss_OnDie(MapID, InstanceID, TargetID, TargetTypeID, RoleID)
	if TargetTypeID == 1535307 then
		cre.MonsterSay(MapID, InstanceID, TargetID, 50080)
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 102, 100125)    --&lt;p1&gt;给予了蚩尤妖魂最后一击！聚集在昆仑的勇士们成功抵挡住了妖魔们的疯狂进攻，使葵灵宝树达到了最终形态！
		msg.AddMsgEvent(MsgID, 2, RoleID)
		msg.DispatchBroadcast(MsgID,-1,-1,-1)
	end
    KuiLingBaoShu_killboss = KuiLingBaoShu_killboss + 1
	if KuiLingBaoShu_killboss == 6 then
	    map.MapCreateColCreature(3017299407, -1, 1535307, feisheng_baoshu[2].x, feisheng_baoshu[2].y, feisheng_baoshu[2].z)
	    local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 101, 3170)    --蚩尤妖魂：顺我者昌，逆我者亡！
		msg.DispatchMapMsgEvent(MsgID, 3017299407, -1)
	end
end

aux.RegisterCreatureEvent(1535301, 4, "KuilingBoss_OnDie")
aux.RegisterCreatureEvent(1535302, 4, "KuilingBoss_OnDie")
aux.RegisterCreatureEvent(1535303, 4, "KuilingBoss_OnDie")
aux.RegisterCreatureEvent(1535304, 4, "KuilingBoss_OnDie")
aux.RegisterCreatureEvent(1535305, 4, "KuilingBoss_OnDie")
aux.RegisterCreatureEvent(1535306, 4, "KuilingBoss_OnDie")
aux.RegisterCreatureEvent(1535307, 4, "KuilingBoss_OnDie")


function s2428801_Cast(mapid, instanceid, skillid, ownerid)
    for i = 2,7 do
	    map.MapCreateColCreature(3017299407, -1, 1535325, feisheng_baoshu[i].x, feisheng_baoshu[i].y, feisheng_baoshu[i].z)
	end
	for j = 8,13 do
	    map.MapCreateColCreature(3017299407, -1, 1535324, feisheng_baoshu[j].x, feisheng_baoshu[j].y, feisheng_baoshu[j].z)
	end
	for k = 14,19 do
	    map.MapCreateColCreature(3017299407, -1, 1535323, feisheng_baoshu[k].x, feisheng_baoshu[k].y, feisheng_baoshu[k].z)
	end
	for q = 6,11 do
	    map.MapCreateColCreature(3017299407, -1, 1535322, feisheng_baoshu[q].x, feisheng_baoshu[q].y, feisheng_baoshu[q].z)
	end
	return 0
end


--注册

aux.RegisterSkillEvent(2428801, 1, "s2428801_Cast")
aux.RegisterSkillEvent(2428901, 1, "s2428801_Cast")
aux.RegisterSkillEvent(2429001, 1, "s2428801_Cast")
aux.RegisterSkillEvent(2429101, 1, "s2428801_Cast")

function s2429201_Cast(mapid, instanceid, skillid, ownerid)

    map.MapCreateColCreature(3017299407, -1, 1535320, 1782, 7991, 2642)
	map.MapCreateColCreature(3017299407, -1, 1535321, 1787, 8010, 2645)

	return 0
end


--注册

aux.RegisterSkillEvent(2429201, 1, "s2429201_Cast")


--可否使用函数
function I1351214_CanUse(MapID, InstanceID, TypeID, TargetID)
	local bRet, bIgnore = 0, false
	if KuiLingBaoShu_jilu[TargetID] == nil or KuiLingBaoShu_jilu[TargetID].guaiwu == nil or KuiLingBaoShu_jilu[TargetID].guaiwu < 100  then
		--提示玩家背包空间不足
		local k = KuiLingBaoShu_jilu[TargetID].guaiwu
		if KuiLingBaoShu_jilu[TargetID].guaiwu == nil then
		    k = 0
		end
		bRet = 32
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 26, 3171)	--混沌经验箱需要储存妖魂达到100个以上才能使用
        msg.DispatchRoleMsgEvent(TargetID, MsgID)
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 26, 3172)	--混沌经验箱储存妖魂数量：XX/100
		msg.AddMsgEvent(MsgID, 9, k)
        msg.DispatchRoleMsgEvent(TargetID, MsgID)
	end
	return bRet, bIgnore
end

aux.RegisterItemEvent(1351214, 0, "I1351214_CanUse")

function I1351214_OnUse(MapID, InstanceID, TypeID, TargetID)
    local rolelevel = role.GetRoleLevel(MapID, InstanceID, TargetID)
	--local roleexp = math.floor(activity_newexp[rolelevel] / 40)
	--role.AddRoleExp(MapID, InstanceID, TargetID, roleexp)
	if KuiLingBaoShu_jilu[TargetID].guaiwu >= 100 and KuiLingBaoShu_jilu[TargetID].guaiwu < 200 then
	    local roleexp = activity_newexp[rolelevel]
		role.AddRoleExp(MapID, InstanceID, TargetID, roleexp)
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 71, 3173)	--您使用了混沌经验箱，将里面妖魂储存的妖魂变为了单倍经验XXX点
        msg.AddMsgEvent(MsgID, 9, roleexp)
		msg.DispatchRoleMsgEvent(TargetID, MsgID)
	elseif KuiLingBaoShu_jilu[TargetID].guaiwu > 200 then
	    local j = math.random(100)
		local k = 1
		if j==100 then
		    k = 4
		elseif j>=93 then
		    k = 3
		else
		    k = 2
		end
	    local roleexp = activity_newexp[rolelevel]*k
		role.AddRoleExp(MapID, InstanceID, TargetID, roleexp)
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 71, 3174)	--您使用了混沌经验箱，将里面妖魂储存的妖魂变为了k倍经验XXX点
        msg.AddMsgEvent(MsgID, 9, k)
		msg.AddMsgEvent(MsgID, 9, roleexp)
		msg.DispatchRoleMsgEvent(TargetID, MsgID)
		if k == 4 then
		    local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 101, 3175)    --XXX使用了混沌经验箱，将里面储存的妖魂变为了k倍经验XXX点
			msg.AddMsgEvent(MsgID, 2, TargetID)
			msg.AddMsgEvent(MsgID, 9, 4)
			msg.AddMsgEvent(MsgID, 9, roleexp)
			msg.DispatchWorldMsgEvent(MsgID)
		end
	end
	KuiLingBaoShu_jilu[TargetID].guaiwu = 0
end

aux.RegisterItemEvent(1351214, 1, "I1351214_OnUse")



function CreatCreature_KuiLingBaoShu(MapID, InstanceID)  --随机刷怪
    local k = math.random(6)
	KuiLingBaoShu_xiaoguai = KuiLingBaoShu_xiaoguai + 1
	if k == 6 then
	    local a = math.random(2,21)
		map.MapCreateColCreature(3017299407, -1, 1535309, feisheng_baoshu[a].x, feisheng_baoshu[a].y, feisheng_baoshu[a].z)
    elseif k == 5 then
        local a = math.random(2,21)
		map.MapCreateColCreature(3017299407, -1, 1535311, feisheng_baoshu[a].x, feisheng_baoshu[a].y, feisheng_baoshu[a].z)
    elseif k == 4 then
        local a = math.random(2,21)
		map.MapCreateColCreature(3017299407, -1, 1535308, feisheng_bossa[a].x, feisheng_bossa[a].y, feisheng_bossa[a].z)
    elseif k == 3 then
        local a = math.random(2,21)
		map.MapCreateColCreature(3017299407, -1, 1535310, feisheng_bossa[a].x, feisheng_bossa[a].y, feisheng_bossa[a].z)
	elseif k == 2 then
        local a = math.random(2,21)
		map.MapCreateColCreature(3017299407, -1, 1535308, feisheng_bossb[a].x, feisheng_bossb[a].y, feisheng_bossb[a].z)
    elseif k == 1 then
        local a = math.random(2,21)
		map.MapCreateColCreature(3017299407, -1, 1535310, feisheng_bossb[a].x, feisheng_bossb[a].y, feisheng_bossb[a].z)
    end
end


