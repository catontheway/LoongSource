
--宝藏守卫列表 45%
UseZhaoYaoFan_BaoZangShouWei = {};
UseZhaoYaoFan_BaoZangShouWei[1] = {MaxLv=50,MinLv=15,TargetID=1510001};
UseZhaoYaoFan_BaoZangShouWei[2] = {MaxLv=60,MinLv=51,TargetID=1510002};
UseZhaoYaoFan_BaoZangShouWei[3] = {MaxLv=70,MinLv=61,TargetID=1510003};
UseZhaoYaoFan_BaoZangShouWei[4] = {MaxLv=80,MinLv=71,TargetID=1510004};
UseZhaoYaoFan_BaoZangShouWei[5] = {MaxLv=90,MinLv=81,TargetID=1510005};
UseZhaoYaoFan_BaoZangShouWei[6] = {MaxLv=98,MinLv=91,TargetID=1510006};
UseZhaoYaoFan_BaoZangShouWei[7] = {MaxLv=110,MinLv=99,TargetID=1510007};
UseZhaoYaoFan_BaoZangShouWei[8] = {MaxLv=50,MinLv=15,TargetID=1510008};
UseZhaoYaoFan_BaoZangShouWei[9] = {MaxLv=60,MinLv=51,TargetID=1510009};
UseZhaoYaoFan_BaoZangShouWei[10] = {MaxLv=70,MinLv=61,TargetID=1510010};
UseZhaoYaoFan_BaoZangShouWei[11] = {MaxLv=80,MinLv=71,TargetID=1510011};
UseZhaoYaoFan_BaoZangShouWei[12] = {MaxLv=90,MinLv=81,TargetID=1510012};
UseZhaoYaoFan_BaoZangShouWei[13] = {MaxLv=98,MinLv=91,TargetID=1510013};
UseZhaoYaoFan_BaoZangShouWei[14] = {MaxLv=110,MinLv=99,TargetID=1510014};

--七星妖列表 25%
UseZhaoYaoFan_QiXingYao = {};
UseZhaoYaoFan_QiXingYao[1] = {MaxLv=50,MinLv=15,TargetID=1510015};
UseZhaoYaoFan_QiXingYao[2] = {MaxLv=60,MinLv=51,TargetID=1510016};
UseZhaoYaoFan_QiXingYao[3] = {MaxLv=70,MinLv=61,TargetID=1510017};
UseZhaoYaoFan_QiXingYao[4] = {MaxLv=80,MinLv=71,TargetID=1510018};
UseZhaoYaoFan_QiXingYao[5] = {MaxLv=90,MinLv=81,TargetID=1510019};
UseZhaoYaoFan_QiXingYao[6] = {MaxLv=110,MinLv=91,TargetID=1510020};

--七星魔君列表 10%
UseZhaoYaoFan_QiXingMoJun = {};
UseZhaoYaoFan_QiXingMoJun[1] = {MaxLv=55,MinLv=15,TargetID=1510072};
UseZhaoYaoFan_QiXingMoJun[2] = {MaxLv=65,MinLv=50,TargetID=1510073};
UseZhaoYaoFan_QiXingMoJun[3] = {MaxLv=75,MinLv=60,TargetID=1510074};
UseZhaoYaoFan_QiXingMoJun[4] = {MaxLv=85,MinLv=75,TargetID=1510075};
UseZhaoYaoFan_QiXingMoJun[5] = {MaxLv=90,MinLv=80,TargetID=1510076};
UseZhaoYaoFan_QiXingMoJun[6] = {MaxLv=110,MinLv=85,TargetID=1510077};

--星宿怪列表 20%
UseZhaoYaoFan_XingXiu = {};
UseZhaoYaoFan_XingXiu[1] = {MaxLv=20,MinLv=15,TargetID=1500001};
UseZhaoYaoFan_XingXiu[2] = {MaxLv=25,MinLv=21,TargetID=1500002};
UseZhaoYaoFan_XingXiu[3] = {MaxLv=25,MinLv=21,TargetID=1500003};
UseZhaoYaoFan_XingXiu[4] = {MaxLv=30,MinLv=26,TargetID=1500004};
UseZhaoYaoFan_XingXiu[5] = {MaxLv=30,MinLv=26,TargetID=1500005};
UseZhaoYaoFan_XingXiu[6] = {MaxLv=35,MinLv=31,TargetID=1500006};
UseZhaoYaoFan_XingXiu[7] = {MaxLv=40,MinLv=36,TargetID=1500007};
UseZhaoYaoFan_XingXiu[8] = {MaxLv=45,MinLv=41,TargetID=1500008};
UseZhaoYaoFan_XingXiu[9] = {MaxLv=50,MinLv=46,TargetID=1500009};
UseZhaoYaoFan_XingXiu[10] = {MaxLv=55,MinLv=51,TargetID=1500010};
UseZhaoYaoFan_XingXiu[11] = {MaxLv=55,MinLv=51,TargetID=1500011};
UseZhaoYaoFan_XingXiu[12] = {MaxLv=60,MinLv=56,TargetID=1500012};
UseZhaoYaoFan_XingXiu[13] = {MaxLv=60,MinLv=56,TargetID=1500013};
UseZhaoYaoFan_XingXiu[14] = {MaxLv=65,MinLv=61,TargetID=1500014};
UseZhaoYaoFan_XingXiu[15] = {MaxLv=65,MinLv=61,TargetID=1500015};
UseZhaoYaoFan_XingXiu[16] = {MaxLv=70,MinLv=66,TargetID=1500016};
UseZhaoYaoFan_XingXiu[17] = {MaxLv=70,MinLv=66,TargetID=1500017};
UseZhaoYaoFan_XingXiu[18] = {MaxLv=75,MinLv=71,TargetID=1500018};
UseZhaoYaoFan_XingXiu[19] = {MaxLv=75,MinLv=71,TargetID=1500019};
UseZhaoYaoFan_XingXiu[20] = {MaxLv=80,MinLv=76,TargetID=1500020};
UseZhaoYaoFan_XingXiu[21] = {MaxLv=80,MinLv=76,TargetID=1500021};
UseZhaoYaoFan_XingXiu[22] = {MaxLv=90,MinLv=81,TargetID=1500022};
UseZhaoYaoFan_XingXiu[23] = {MaxLv=90,MinLv=81,TargetID=1500023};
UseZhaoYaoFan_XingXiu[24] = {MaxLv=90,MinLv=81,TargetID=1500024};
UseZhaoYaoFan_XingXiu[25] = {MaxLv=90,MinLv=81,TargetID=1500025};
UseZhaoYaoFan_XingXiu[26] = {MaxLv=110,MinLv=91,TargetID=1500026};
UseZhaoYaoFan_XingXiu[27] = {MaxLv=110,MinLv=91,TargetID=1500027};
UseZhaoYaoFan_XingXiu[28] = {MaxLv=110,MinLv=96,TargetID=1500028};

--用于检测是否是大地图
CanUseMapENUM = {};
CanUseMapENUM[3017298127]=1;
CanUseMapENUM[3017298383]=1;
CanUseMapENUM[3017299663]=1;
CanUseMapENUM[3017299919]=1;
CanUseMapENUM[3017299151]=1;
CanUseMapENUM[3017299407]=1;

--随机选取一个对应等级区间内的怪物ID的函数
function RefreshMonster(MapID, InstanceID, RoleID, TargetTable)
	local RoleLv = role.GetRoleLevel(MapID, InstanceID, RoleID);
	local AvailTargetID = {};
	for i=1,table.maxn(TargetTable) do
		if RoleLv<=TargetTable[i].MaxLv and RoleLv>=TargetTable[i].MinLv then
			table.insert(AvailTargetID,TargetTable[i].TargetID);
		end
	end
	if table.getn(AvailTargetID)>1 then
	return AvailTargetID[math.random(1,table.maxn(AvailTargetID))]
	else
	return AvailTargetID[1]
	end
end

function I2616327_OnUse(MapID, InstanceID, TypeID, RoleID)
	--玩家使用招妖幡后，根据几率刷出不同种类怪物
	local Rand = math.random(1,100);
	local MsgID = msg.BeginMsgEvent();
	if Rand<=45 then
		local TargetID = RefreshMonster(MapID, InstanceID,RoleID,UseZhaoYaoFan_BaoZangShouWei);
		local x,y,z = unit.GetPosition(MapID, InstanceID, RoleID);
		map.MapCreateColCreature(MapID, InstanceID, TargetID,x,y,z,1,"");
		local Rand_1 = math.random(1,100);
		if Rand_1<21 then
			msg.AddMsgEvent(MsgID, 102, 100083);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			--msg.DispatchBroadcast(MsgID,MapID,InstanceID,-1);
			--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为10分钟
			RunBroad(MsgID, MapID, InstanceID, -1, RoleID, DPR_INMAP, DPR_INTEAM, TypeID, 10)
		elseif Rand_1<41 then
			msg.AddMsgEvent(MsgID, 102, 100084);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			--msg.DispatchBroadcast(MsgID,MapID,InstanceID,-1);
			--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为10分钟
			RunBroad(MsgID, MapID, InstanceID, -1, RoleID, DPR_INMAP, DPR_INTEAM, TypeID, 10)
		elseif Rand_1<61 then
			msg.AddMsgEvent(MsgID, 102, 100085);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			--msg.DispatchBroadcast(MsgID,MapID,InstanceID,-1);
			--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为10分钟
			RunBroad(MsgID, MapID, InstanceID, -1, RoleID, DPR_INMAP, DPR_INTEAM, TypeID, 10)
		elseif Rand_1>96 then
			msg.AddMsgEvent(MsgID, 102, 100086);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			--msg.DispatchBroadcast(MsgID,-1,-1,-1);
			--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为10分钟
			RunBroad(MsgID, -1, -1, -1, RoleID, DPR_ALL, DPR_INTEAM, TypeID, 20)
		end
	elseif Rand>45 and Rand<=70 then
		local TargetID = RefreshMonster(MapID, InstanceID,RoleID,UseZhaoYaoFan_QiXingYao);
		local x,y,z = unit.GetPosition(MapID, InstanceID, RoleID);
		map.MapCreateColCreature(MapID, InstanceID, TargetID,x,y,z,1,"");
		local Rand_1 = math.random(1,100);
		if Rand_1<31 then
			msg.AddMsgEvent(MsgID, 102, 100083);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			--msg.DispatchBroadcast(MsgID,MapID,InstanceID,-1);
			--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为10分钟
			RunBroad(MsgID, MapID, InstanceID, -1, RoleID, DPR_INMAP, DPR_INTEAM, TypeID, 10)
		elseif Rand_1<61 then
			msg.AddMsgEvent(MsgID, 102, 100085);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			--msg.DispatchBroadcast(MsgID,MapID,InstanceID,-1);
			--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为10分钟
			RunBroad(MsgID, MapID, InstanceID, -1, RoleID, DPR_INMAP, DPR_INTEAM, TypeID, 10)
		elseif Rand_1>94 then
			msg.AddMsgEvent(MsgID, 102, 100086);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			msg.DispatchBroadcast(MsgID,-1,-1,-1);
			--msg.DispatchBroadcast(MsgID,-1,-1,-1);
			--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为20分钟
			RunBroad(MsgID, -1, -1, -1, RoleID, DPR_ALL, DPR_INTEAM, TypeID, 20)
		end
	elseif Rand>70 and Rand<=90 then
		local TargetID = RefreshMonster(MapID, InstanceID,RoleID,UseZhaoYaoFan_XingXiu);
		local x,y,z = unit.GetPosition(MapID, InstanceID, RoleID);
		map.MapCreateColCreature(MapID, InstanceID, TargetID,x,y,z,1,"");
		local Rand_1 = math.random(1,100);
		if Rand_1<31 then
			msg.AddMsgEvent(MsgID, 102, 100087);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			if math.random(1,5)<=3 then
				--msg.DispatchBroadcast(MsgID,MapID,InstanceID,-1);
				--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为5分钟
				RunBroad(MsgID, MapID, InstanceID, -1, RoleID, DPR_INMAP, DPR_INTEAM, TypeID, 5)
			else
				--msg.DispatchBroadcast(MsgID,-1,-1,-1);
				--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为5分钟
				RunBroad(MsgID, -1, -1, -1, RoleID, DPR_ALL, DPR_INTEAM, TypeID, 5)
			end
		elseif Rand_1<61 then
			msg.AddMsgEvent(MsgID, 102, 100088);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			if math.random(1,5)<=3 then
				--msg.DispatchBroadcast(MsgID,MapID,InstanceID,-1);
				--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为5分钟
				RunBroad(MsgID, MapID, InstanceID, -1, RoleID, DPR_INMAP, DPR_INTEAM, TypeID, 5)
			else
				--msg.DispatchBroadcast(MsgID,-1,-1,-1);
				--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为5分钟
				RunBroad(MsgID, -1, -1, -1, RoleID, DPR_ALL, DPR_INTEAM, TypeID, 5)
			end
		elseif Rand_1<91 then
			msg.AddMsgEvent(MsgID, 102, 100089);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			if math.random(1,5)<=3 then
				--msg.DispatchBroadcast(MsgID,MapID,InstanceID,-1);
				--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为5分钟
				RunBroad(MsgID, MapID, InstanceID, -1, RoleID, DPR_INMAP, DPR_INTEAM, TypeID, 5)
			else
				--msg.DispatchBroadcast(MsgID,-1,-1,-1);
				--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为5分钟
				RunBroad(MsgID, -1, -1, -1, RoleID, DPR_ALL, DPR_INTEAM, TypeID, 5)
			end
		elseif Rand_1<96 then
			msg.AddMsgEvent(MsgID, 102, 100090);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			--msg.DispatchBroadcast(MsgID,-1,-1,-1);
			--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为1分钟
			RunBroad(MsgID, -1, -1, -1, RoleID, DPR_ALL, DPR_INTEAM, TypeID, 1)
		else
			msg.AddMsgEvent(MsgID, 102, 100091);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 5, TargetID);
			--msg.DispatchBroadcast(MsgID,-1,-1,-1);
			--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为1分钟
			RunBroad(MsgID, -1, -1, -1, RoleID, DPR_ALL, DPR_INTEAM, TypeID, 1)
		end
	else
		local TargetID = RefreshMonster(MapID, InstanceID,RoleID,UseZhaoYaoFan_QiXingMoJun);
		local x,y,z = unit.GetPosition(MapID, InstanceID, RoleID);
		map.MapCreateColCreature(MapID, InstanceID, TargetID,x,y,z,1,"");
		local Rand_1 = math.random(1,100);
		if Rand_1<90 then
			msg.AddMsgEvent(MsgID, 102, 100093);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			--msg.AddMsgEvent(MsgID, 6, MapID);
		else
			msg.AddMsgEvent(MsgID, 102, 100092);
			msg.AddMsgEvent(MsgID, 2, RoleID);
			msg.AddMsgEvent(MsgID, 6, MapID);
		end
			--msg.DispatchBroadcast(MsgID,-1,-1,-1);
			--同样由使用招妖幡事件激发的两条广播之间最小时间间隔为1分钟
			RunBroad(MsgID, -1, -1, -1, RoleID, DPR_ALL, DPR_INTEAM, TypeID, 0)
	end
end

--检测物品是否可使用
function I2616327_CanUse(MapID, InstanceID, TypeID, RoleID)
	local bRet, bIgnore = 0, false

	--判断玩家等级
	if role.GetRoleLevel(MapID, InstanceID, RoleID)==nil or role.GetRoleLevel(MapID, InstanceID, RoleID)<15 then
		bRet = 35
		return bRet,false
	else
		--判断玩家是否在副本中
		if CanUseMapENUM[MapID] == 1 then
			bRet = 0;
			return bRet,false
		else
			--提示玩家不可在副本中使用
			local MsgID = msg.BeginMsgEvent();
			msg.AddMsgEvent(MsgID, 26, 2725);
			msg.DispatchRoleMsgEvent(RoleID, MsgID);
			bRet = 999;
			return bRet,false
		end
	end
	return bRet,false
end


--注册玩家使用招妖幡事件--
aux.RegisterItemEvent(2616327, 1, "I2616327_OnUse")
aux.RegisterItemEvent(2616327, 0, "I2616327_CanUse")
