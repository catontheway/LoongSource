chunjie_NPC = {}
chunjie_NPC[1] = {npcid=4900419, x=2196, y=6646, z=2234, x2=2121, y2=18345, z2=2675}
chunjie_NPC[2] = {npcid=4900424, x=2200, y=6646, z=2234, x2=2128, y2=18345, z2=2675}
chunjie_NPC[3] = {npcid=4900418, x=2187, y=6646, z=2235, x2=2129, y2=18345, z2=2664}
chunjie_NPC[4] = {npcid=4900407, x=2200, y=6646, z=2229, x2=2124, y2=18345, z2=2664}


chunjie_mon={}
chunjie_mon[1]={mapid=3017298127, x=2160, y=6646, z=2234, monid=0}--龙城年兽
chunjie_mon[2]={mapid=3017299663, x=2103, y=18345, z=2670, monid=0}--黄帝城年兽
chunjie_mon[3]={mapid=3017298383, x=910, y=10464, z=2050, monid=0}--凤翔春之花火


NianShou_LongCheng_Pos = {}
NianShou_LongCheng_Pos[1]={x=2211 ,y=6646 ,z=2240}
NianShou_LongCheng_Pos[2]={x=2204 ,y=6646 ,z=2234}
NianShou_LongCheng_Pos[3]={x=2209 ,y=6646 ,z=2225}
NianShou_LongCheng_Pos[4]={x=2217 ,y=6646 ,z=2227}
NianShou_LongCheng_Pos[5]={x=2218 ,y=6646 ,z=2235}
NianShou_LongCheng_Pos[6]={x=2211 ,y=6646 ,z=2233}
NianShou_LongCheng_Pos[7]={x=2152 ,y=6646 ,z=2236}
NianShou_LongCheng_Pos[8]={x=2147 ,y=6646 ,z=2223}
NianShou_LongCheng_Pos[9]={x=2162 ,y=6646 ,z=2247}
NianShou_LongCheng_Pos[10]={x=2166 ,y=6646 ,z=2242}
NianShou_LongCheng_Pos[11]={x=2148 ,y=6646 ,z=2251}
NianShou_LongCheng_Pos[12]={x=2117 ,y=6646 ,z=2250}
NianShou_LongCheng_Pos[13]={x=2101 ,y=6646 ,z=2241}
NianShou_LongCheng_Pos[14]={x=2088 ,y=6646 ,z=2253}
NianShou_LongCheng_Pos[15]={x=2080 ,y=6646 ,z=2269}
NianShou_LongCheng_Pos[16]={x=2077 ,y=6646 ,z=2290}
NianShou_LongCheng_Pos[17]={x=2103 ,y=6646 ,z=2277}
NianShou_LongCheng_Pos[18]={x=2207 ,y=6646 ,z=2256}
NianShou_LongCheng_Pos[19]={x=2256 ,y=6646 ,z=2258}
NianShou_LongCheng_Pos[20]={x=2275 ,y=6646 ,z=2252}
NianShou_LongCheng_Pos[21]={x=2269 ,y=6646 ,z=2286}
NianShou_LongCheng_Pos[22]={x=2294 ,y=6646 ,z=2268}
NianShou_LongCheng_Pos[23]={x=2166 ,y=6646 ,z=2262}
NianShou_LongCheng_Pos[24]={x=2197 ,y=6646 ,z=2263}
NianShou_LongCheng_Pos[25]={x=2153 ,y=6646 ,z=2202}
NianShou_LongCheng_Pos[26]={x=2296 ,y=5733 ,z=2206}
NianShou_LongCheng_Pos[27]={x=2196 ,y=5738 ,z=2139}
NianShou_LongCheng_Pos[28]={x=2213 ,y=5738 ,z=2113}
NianShou_LongCheng_Pos[29]={x=2160 ,y=5738 ,z=2126}
NianShou_LongCheng_Pos[30]={x=2160 ,y=5738 ,z=2091}

NianShou_HuangDi_Pos = {}
NianShou_HuangDi_Pos[1]={x=2024 ,y=18345 ,z=2737}
NianShou_HuangDi_Pos[2]={x=2012 ,y=18345 ,z=2753}
NianShou_HuangDi_Pos[3]={x=2182 ,y=18345 ,z=2707}
NianShou_HuangDi_Pos[4]={x=2195 ,y=18345 ,z=2749}
NianShou_HuangDi_Pos[5]={x=2142 ,y=18345 ,z=2689}
NianShou_HuangDi_Pos[6]={x=2164 ,y=18338 ,z=2391}
NianShou_HuangDi_Pos[7]={x=2129 ,y=18338 ,z=2421}
NianShou_HuangDi_Pos[8]={x=2107 ,y=18338 ,z=2450}
NianShou_HuangDi_Pos[9]={x=2070 ,y=18338 ,z=2411}
NianShou_HuangDi_Pos[10]={x=2071 ,y=18338 ,z=2402}
NianShou_HuangDi_Pos[11]={x=2013 ,y=18345 ,z=2714}
NianShou_HuangDi_Pos[12]={x=2035 ,y=18345 ,z=2691}
NianShou_HuangDi_Pos[13]={x=2167 ,y=18345 ,z=2699}
NianShou_HuangDi_Pos[14]={x=2155 ,y=18345 ,z=2705}
NianShou_HuangDi_Pos[15]={x=2137 ,y=18345 ,z=2656}
NianShou_HuangDi_Pos[16]={x=2068 ,y=18345 ,z=2655}
NianShou_HuangDi_Pos[17]={x=2130 ,y=18345 ,z=2703}
NianShou_HuangDi_Pos[18]={x=2046 ,y=18345 ,z=2709}
NianShou_HuangDi_Pos[19]={x=2101 ,y=18345 ,z=2706}
NianShou_HuangDi_Pos[20]={x=2065 ,y=18345 ,z=2697}
NianShou_HuangDi_Pos[21]={x=2093 ,y=18345 ,z=2677}
NianShou_HuangDi_Pos[22]={x=2098 ,y=18345 ,z=2687}
NianShou_HuangDi_Pos[23]={x=2104 ,y=18345 ,z=2675}
NianShou_HuangDi_Pos[24]={x=2096 ,y=18345 ,z=2667}
NianShou_HuangDi_Pos[25]={x=2084 ,y=18345 ,z=2672}
NianShou_HuangDi_Pos[26]={x=2084 ,y=18345 ,z=2686}
NianShou_HuangDi_Pos[27]={x=2064 ,y=18345 ,z=2671}
NianShou_HuangDi_Pos[28]={x=2084 ,y=18345 ,z=2660}
NianShou_HuangDi_Pos[29]={x=2118 ,y=18345 ,z=2663}
NianShou_HuangDi_Pos[30]={x=2126 ,y=18345 ,z=2677}
--鞭炮使用
function I3303131_OnUse(MapID, InstanceID, TypeID, RoleID)

	local monid = 0
	if MapID == 3017298127 then
		monid = chunjie_mon[1].monid
	elseif MapID == 3017299663 then
		monid = chunjie_mon[2].monid
	end
		unit.AddBuff(MapID, InstanceID, monid, 9428101, monid) --减血100
		--unit.AddBuff(MapID, InstanceID, monid, 5003301, monid) --添加鞭炮特效

		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 26, 1357)--噼噼啪,你使用鞭炮对年兽造成100点伤害！！
		msg.DispatchRoleMsgEvent(RoleID, MsgID)

		local a = math.random(100)
		local b = math.random(100)
		local c = math.random(1,7)

		if a >= 95 then
			role.AddRoleItem(MapID, InstanceID, RoleID, 3303005, 1, -1, 8, 420)
		end
		if b <= 25 then
			role.AddRoleItem(MapID, InstanceID, RoleID, 3303004, 1, -1, 8, 420)
		end

	local HP = unit.GetUnitAttValue(MapID, InstanceID, monid, 9)
	if HP == 7500 or HP == 5000 or HP == 2500 then
		unit.AddBuff(MapID, InstanceID, monid, 9428201, monid) --缩小体型
	end
end
--鞭炮能否使用
function I3303131_CanUse(MapID, InstanceID, TypeID, RoleID)
	local a = chunjie_mon[1].monid
	local b = chunjie_mon[2].monid
	local x, y, z = unit.GetPosition(MapID, InstanceID, RoleID)

	--判断背包空闲空间是否足够
	local FreeSize = role.GetBagFreeSize(RoleID)
	if(FreeSize < 2) then
		return 40, false
	end

	if MapID == 3017298127 then
		if x < chunjie_mon[1].x - 25 or x > chunjie_mon[1].x + 25 or z < chunjie_mon[1].z - 25 or z > chunjie_mon[1].z + 25 then
			return 43 ,false
		else
			if a == 0 then
				local MsgID = msg.BeginMsgEvent()
				msg.AddMsgEvent(MsgID, 26, 1352)--周围没有年兽，无法使用鞭炮
				msg.DispatchRoleMsgEvent(RoleID, MsgID)
				return 32 ,false
			else
				return 0 ,false
			end
		end
	elseif MapID == 3017299663 then
		if x < chunjie_mon[2].x - 25 or x > chunjie_mon[2].x + 25 or z < chunjie_mon[2].z - 25 or z > chunjie_mon[2].z + 25 then
			return 43 ,false
		else
			if b == 0 then
				local MsgID = msg.BeginMsgEvent()
				msg.AddMsgEvent(MsgID, 26, 1352)--周围没有年兽，无法使用鞭炮
				msg.DispatchRoleMsgEvent(RoleID, MsgID)
				return 32 ,false
			else
				return 0 ,false
			end
		end
	else
		return 43,false
	end
end

aux.RegisterItemEvent(3303131, 1, "I3303131_OnUse")
aux.RegisterItemEvent(3303131, 0, "I3303131_CanUse")

--高级烟火使用
function I3303127_OnUse(MapID, InstanceID, TypeID, RoleID)
	--给经验和物品奖励-
		local x, y ,z = unit.GetPosition(MapID, InstanceID, RoleID)
		local ID = map.MapCreateColCreature(MapID, InstanceID, 4900601, x, y, z, 1)
		local r = math.random(1,7)

		unit.AddBuff(MapID, InstanceID, ID, 2021501+100*r, ID)

		local rolelevel = role.GetRoleLevel(MapID, InstanceID, RoleID)
		local roleexp = growth_exp[rolelevel].im
		role.AddRoleExp(MapID, InstanceID, RoleID, roleexp)	-- 增加经验
		local a = math.random(100)
		local b = math.random(100)
		local c = math.random(1,7)
		local d = math.random(100)

		if a >= 90 then
			role.AddRoleItem(MapID, InstanceID, RoleID, 3303005, 1, -1, 8, 420)
		end
		if b >= 20 then
			role.AddRoleItem(MapID, InstanceID, RoleID, 3303004, 1, -1, 8, 420)
		end

		if d >= 98 then
		role.AddRoleItem(MapID, InstanceID, RoleID, 3303002, 1, -1, 8, 420)
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 100, 1359)---过大年，放烟花，"角色名"放烟花放的兴高采烈，获得一个金虎如意匣。
		msg.AddMsgEvent(MsgID, 2, RoleID)
		msg.DispatchWorldMsgEvent(MsgID)
		end
		role.AddRoleItem(MapID, InstanceID, RoleID, 1350500+c, 1, -1, 8, 420)
		role.AddRoleItem(MapID, InstanceID, RoleID, 3303131, 2, -1, 8, 420)

end
--高级烟火能否使用
function I3303127_CanUse(MapID, InstanceID, TypeID, RoleID)

local bRet, bIgnore = 0, false
	--判断背包空闲空间是否足够
	local FreeSize = role.GetBagFreeSize(RoleID)
	if(FreeSize < 4) then
		return 40, false
	end

	local c = chunjie_mon[3].monid
	local x, y, z = unit.GetPosition(MapID, InstanceID, RoleID)
	if MapID == 3017298383 then
		if x < chunjie_mon[3].x - 50 or x > chunjie_mon[3].x + 50 or z < chunjie_mon[3].z - 50 or z > chunjie_mon[3].z + 50 then
			return 43,false
		elseif c == 0 then
			local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 26, 1356)--只能在凤翔春之花火附近使用。
			msg.DispatchRoleMsgEvent(RoleID, MsgID)
			return 32 ,false
		else
			return 0 ,false
		end
	else
		return 43,false
	end
end

aux.RegisterItemEvent(3303127, 1, "I3303127_OnUse")
aux.RegisterItemEvent(3303127, 0, "I3303127_CanUse")

function ChunJie_OnStart(actID)

	for i = 2,4 do
		map.MapCreateColCreature(3017298127, -1, chunjie_NPC[i].npcid, chunjie_NPC[i].x, chunjie_NPC[i].y, chunjie_NPC[i].z,1)
		map.MapCreateColCreature(3017299663, -1, chunjie_NPC[i].npcid, chunjie_NPC[i].x2, chunjie_NPC[i].y2, chunjie_NPC[i].z2,1)
	end
end

function ChunJie_OnTimerMin(actID)

	local curhour = tonumber(os.date("%H"))
	local curmin = tonumber(os.date("%M"))

	if (curhour == 18 or curhour == 19 or curhour == 20 or curhour == 21 or curhour == 22) and curmin == 55 then
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 100, 1358)---年兽已出现于玄天龙城及黄帝城的显著位置，请大家使用鞭炮将其驱赶。
		msg.DispatchWorldMsgEvent(MsgID)
	end

	if (curhour==19 or curhour==20 or curhour==21 or curhour==22 or curhour==23) and curmin==0 then
		local a = map.MapCreateColCreature(chunjie_mon[1].mapid, -1, 1534102, chunjie_mon[1].x, chunjie_mon[1].y, chunjie_mon[1].z,1)--龙城年兽
		local b = map.MapCreateColCreature(chunjie_mon[2].mapid, -1, 1534102, chunjie_mon[2].x, chunjie_mon[2].y, chunjie_mon[2].z,1)--黄帝年兽
		chunjie_mon[1].monid = a
		chunjie_mon[2].monid = b
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 100, 1353)---年兽已出现于玄天龙城及黄帝城的显著位置，请大家使用鞭炮将其驱赶。
		msg.DispatchWorldMsgEvent(MsgID)
	end

	if curhour==20 and curmin == 0 then
		local c = map.MapCreateColCreature(3017298383, -1, 4900426, chunjie_mon[3].x, chunjie_mon[3].y, chunjie_mon[3].z,1)--凤翔花火
		chunjie_mon[3].monid = c

		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 100, 1355)---烟火大会即将在凤翔府开始，可在春之花火附近使用高级烟火获得意外的惊喜。
		msg.DispatchWorldMsgEvent(MsgID)
	end

	if (curhour == 13 or curhour == 21) and curmin == 0 then
		map.MapCreateColCreature(3017298127, -1, chunjie_NPC[1].npcid, chunjie_NPC[1].x, chunjie_NPC[1].y, chunjie_NPC[1].z,1)
		map.MapCreateColCreature(3017299663, -1, chunjie_NPC[1].npcid, chunjie_NPC[1].x2, chunjie_NPC[1].y2, chunjie_NPC[1].z2,1)
	end

end

--注册该活动的相关事件
aux.RegisterActEvent(75, 2, "ChunJie_OnStart")
aux.RegisterActEvent(75, 4, "ChunJie_OnTimerMin")

function C1534102_OnDie(MapID, InstanceID, CreatureID, CreatureTypeID, RoleID)

	if MapID==3017298127 then
		chunjie_mon[1].monid = 0
		for k = 1,30 do
		map.MapCreateColCreature(3017298127, -1, 1534103, NianShou_LongCheng_Pos[k].x, NianShou_LongCheng_Pos[k].y, NianShou_LongCheng_Pos[k].z, 1)
		end
				map.MapCreateColCreature(3017298127, -1, 4900438, chunjie_mon[1].x, chunjie_mon[1].y, chunjie_mon[1].z, 1)

	elseif MapID==3017299663 then
		chunjie_mon[2].monid = 0
		for k = 1,30 do
		map.MapCreateColCreature(3017299663, -1, 1534103, NianShou_HuangDi_Pos[k].x, NianShou_HuangDi_Pos[k].y, NianShou_HuangDi_Pos[k].z, 1)
		end
				map.MapCreateColCreature(3017299663, -1, 4900438, chunjie_mon[2].x, chunjie_mon[2].y, chunjie_mon[2].z, 1)

	end

	local MsgID = msg.BeginMsgEvent()
	msg.AddMsgEvent(MsgID, 13, 1)
	msg.AddMsgEvent(MsgID, 1, 1354)--位于(地名)的年兽已经被消灭掉，于城中发生小年兽暴动事件。
	msg.AddMsgEvent(MsgID, 6, MapID)
	msg.DispatchMapMsgEvent(MsgID, MapID, -1)
end

aux.RegisterCreatureEvent(1534102, 4, "C1534102_OnDie")

