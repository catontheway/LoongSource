Quest_YuanXiaoRand = {}
Quest_YuanXiaoRand[1]={TargetType=QuestTargetType["Collect"], TargetID1=3303035, TargetID2=0, TargetID3=0, TargetID4=0, Num1=3, Num2=0, Num3=0, Num4=0, MsgID=21001}--
Quest_YuanXiaoRand[2]={TargetType=QuestTargetType["Collect"], TargetID1=3303036, TargetID2=0, TargetID3=0, TargetID4=0, Num1=3, Num2=0, Num3=0, Num4=0, MsgID=21002}--
Quest_YuanXiaoRand[3]={TargetType=QuestTargetType["Collect"], TargetID1=3303037, TargetID2=0, TargetID3=0, TargetID4=0, Num1=3, Num2=0, Num3=0, Num4=0, MsgID=21003}--
Quest_YuanXiaoRand[4]={TargetType=QuestTargetType["Collect"], TargetID1=3303038, TargetID2=0, TargetID3=0, TargetID4=0, Num1=3, Num2=0, Num3=0, Num4=0, MsgID=21004}--
Quest_YuanXiaoRand[5]={TargetType=QuestTargetType["Collect"], TargetID1=3303039, TargetID2=0, TargetID3=0, TargetID4=0, Num1=3, Num2=0, Num3=0, Num4=0, MsgID=21005}--
Quest_YuanXiaoRand[6]={TargetType=QuestTargetType["Collect"], TargetID1=3303040, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=21006}--
Quest_YuanXiaoRand[7]={TargetType=QuestTargetType["Collect"], TargetID1=3303041, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=21007}--
Quest_YuanXiaoRand[8]={TargetType=QuestTargetType["Collect"], TargetID1=3303042, TargetID2=0, TargetID3=0, TargetID4=0, Num1=1, Num2=0, Num3=0, Num4=0, MsgID=21008}--
Quest_YuanXiaoRand[101]={TargetType=QuestTargetType["Kill"], TargetID1=1003025, TargetID2=1003026, TargetID3=0, TargetID4=0, Num1=10, Num2=0, Num3=0, Num4=0, MsgID=21101}--
Quest_YuanXiaoRand[102]={TargetType=QuestTargetType["Kill"], TargetID1=1003091, TargetID2=1003092, TargetID3=0, TargetID4=0, Num1=10, Num2=0, Num3=0, Num4=0, MsgID=21102}--
Quest_YuanXiaoRand[103]={TargetType=QuestTargetType["Kill"], TargetID1=1004109, TargetID2=1004110, TargetID3=1004111, TargetID4=0, Num1=10, Num2=0, Num3=0, Num4=0, MsgID=21103}--
Quest_YuanXiaoRand[104]={TargetType=QuestTargetType["Kill"], TargetID1=1004236, TargetID2=1004237, TargetID3=0, TargetID4=0, Num1=10, Num2=0, Num3=0, Num4=0, MsgID=21104}--
Quest_YuanXiaoRand[105]={TargetType=QuestTargetType["Kill"], TargetID1=1005205, TargetID2=1005206, TargetID3=0, TargetID4=0, Num1=10, Num2=0, Num3=0, Num4=0, MsgID=21105}--
Quest_YuanXiaoRand[106]={TargetType=QuestTargetType["Kill"], TargetID1=1005321, TargetID2=1005322, TargetID3=0, TargetID4=0, Num1=10, Num2=0, Num3=0, Num4=0, MsgID=21106}--
Quest_YuanXiaoRand[107]={TargetType=QuestTargetType["Kill"], TargetID1=1006413, TargetID2=0, TargetID3=0, TargetID4=0, Num1=10, Num2=0, Num3=0, Num4=0, MsgID=21107}--
Quest_YuanXiaoRand[108]={TargetType=QuestTargetType["Kill"], TargetID1=1007139, TargetID2=1007140, TargetID3=1007125, TargetID4=0, Num1=10, Num2=0, Num3=0, Num4=0, MsgID=21108}--
Quest_YuanXiaoRand[109]={TargetType=QuestTargetType["Kill"], TargetID1=1009037, TargetID2=0, TargetID3=0, TargetID4=0, Num1=10, Num2=0, Num3=0, Num4=0, MsgID=21109}--
Quest_YuanXiaoRand[110]={TargetType=QuestTargetType["Kill"], TargetID1=1009307, TargetID2=1009308, TargetID3=0, TargetID4=0, Num1=10, Num2=0, Num3=0, Num4=0, MsgID=21110}--
Quest_YuanXiaoRand[201]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010117, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21201}--
Quest_YuanXiaoRand[202]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010121, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21202}--
Quest_YuanXiaoRand[203]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010122, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21203}--
Quest_YuanXiaoRand[204]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010128, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21204}--
Quest_YuanXiaoRand[205]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010129, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21205}--
Quest_YuanXiaoRand[206]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010136, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21206}--
Quest_YuanXiaoRand[207]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010043, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21207}--
Quest_YuanXiaoRand[208]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010044, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21208}--
Quest_YuanXiaoRand[209]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010045, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21209}--
Quest_YuanXiaoRand[210]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010087, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21210}--
Quest_YuanXiaoRand[211]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010089, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21211}--
Quest_YuanXiaoRand[212]={TargetType=QuestTargetType["NPCTalk"], TargetID1=3010098, TargetID2=0, TargetID3=0, TargetID4=0, Num1=0, Num2=0, Num3=0, Num4=0, MsgID=21212}--

YuanXiaoTime = {}     --记录元宵节任务的时间
YuanXiaoQuest = {}      --记录元宵节任务的进行次数

--接取任务
function H20184_OnQuestInit(MapID, InstanceID, QuestID, RoleID, NPCID)

    local k = math.random(1,5)
	if k <= 2 then
		local Index = math.random(1,8)
		--初始化任务的动态数据
		role.QuestInit(RoleID, QuestID, GetRandQuestTable(Quest_YuanXiaoRand, Index))
		--同步客户端任务说明
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 11, QuestID)
		msg.AddMsgEvent(MsgID, 1, Quest_YuanXiaoRand[Index].MsgID)
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
	elseif k <= 4 then
	    local Index = math.random(1,12) + 200
		--初始化任务的动态数据
		role.QuestInit(RoleID, QuestID, GetRandQuestTable(Quest_YuanXiaoRand, Index))
		--同步客户端任务说明
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 11, QuestID)
		msg.AddMsgEvent(MsgID, 1, Quest_YuanXiaoRand[Index].MsgID)
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
	elseif k == 5 then
	    local RoleLvl = role.GetRoleLevel(MapID, InstanceID, RoleID)
	    local Index = 101
		if RoleLvl <=15 then
		    Index = 101
		elseif RoleLvl <=25 then
		    Index = 102
		elseif RoleLvl <=35 then
		    Index = 103
		elseif RoleLvl <=45 then
		    Index = 104
		elseif RoleLvl <=55 then
		    Index = 105
		elseif RoleLvl <=65 then
		    Index = 106
		elseif RoleLvl <=75 then
		    Index = 107
		elseif RoleLvl <=85 then
		    Index = 108
		elseif RoleLvl <=95 then
		    Index = 109
		elseif RoleLvl <=100 then
		    Index = 110
		end
	    --初始化任务的动态数据
		role.QuestInit(RoleID, QuestID, GetRandQuestTable(Quest_YuanXiaoRand, Index))
		--同步客户端任务说明
		local MsgID = msg.BeginMsgEvent()
		msg.AddMsgEvent(MsgID, 11, QuestID)
		msg.AddMsgEvent(MsgID, 1, Quest_YuanXiaoRand[Index].MsgID)
		msg.DispatchRoleMsgEvent(RoleID, MsgID)
	end
end

--完成任务
function H20184_OnComplete(MapID, InstanceID, QuestID, RoleID, NPCID)

	local exp_award = {}
	exp_award[10] = 850
	exp_award[15] = 1475
	exp_award[20] = 2100
	exp_award[25] = 2725
	exp_award[30] = 3350
	exp_award[35] = 3975
	exp_award[40] = 4600
	exp_award[45] = 5650
	exp_award[50] = 6700
	exp_award[55] = 7750
	exp_award[60] = 9060
	exp_award[65] = 10760
	exp_award[70] = 12120
	exp_award[75] = 14160
	exp_award[80] = 16200
	exp_award[85] = 18400
	exp_award[90] = 21000
	exp_award[95] = 25200
	exp_award[100] = 30276


	local RoleLvl = role.GetRoleLevel(MapID, InstanceID, RoleID)
	local k = math.floor(RoleLvl/5)
	k = k * 5
	--奖励玩家经验与金钱
	role.AddRoleExp(MapID, InstanceID, RoleID, exp_award[k])
	if YuanXiaoQuest[RoleID] == nil then
	    YuanXiaoQuest[RoleID] = 0
	end
	YuanXiaoQuest[RoleID] = YuanXiaoQuest[RoleID] + 1
	if YuanXiaoQuest[RoleID] == 5 or YuanXiaoQuest[RoleID] == 10 then
	    role.AddRoleItem(MapID, InstanceID, RoleID, 3303136, 1, -1, 8, 102)
	end
end

function H20184_OnCheckAccept(MapID, InstanceID, QuestID, RoleID, NPCID)
--检测任务上次更新日期，若与当前日期不一致，则重置总环数及更新日期
	local TotalNum = YuanXiaoQuest[RoleID]
	local UpdateTime = YuanXiaoTime[RoleID]
	local CurTime = tonumber(os.date("%j"))
	if CurTime ~= UpdateTime then
		YuanXiaoTime[RoleID] = CurTime
		YuanXiaoQuest[RoleID] = 0
	else
	    if YuanXiaoQuest[RoleID] == 10 then
			local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 26, 147)
			msg.DispatchRoleMsgEvent(RoleID, MsgID)
		    return 0
	    else
			return 1
		end
	end
end

function H20184_OnCheckComplete(MapID, InstanceID, QuestID, RoleID, NPCID)
    if YuanXiaoQuest[RoleID] == 5 or YuanXiaoQuest[RoleID] == 10 then
	--判断背包空闲空间是否足够
		local FreeSize = role.GetBagFreeSize(RoleID)
		if(FreeSize < 1) then
			local MsgID = msg.BeginMsgEvent()
			msg.AddMsgEvent(MsgID, 26, 142)
			msg.DispatchRoleMsgEvent(RoleID, MsgID)
			return 0
		end
	end
	return 1
end


aux.RegisterQuestEvent(20184, 1, "H20184_OnComplete")
aux.RegisterQuestEvent(20184, 7, "H20184_OnQuestInit")
aux.RegisterQuestEvent(20184, 4, "H20184_OnCheckAccept")
aux.RegisterQuestEvent(20184, 5, "H20184_OnCheckComplete")
